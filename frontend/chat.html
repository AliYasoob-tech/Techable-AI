<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable AI Chat</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div class="chat-app-container">
        
        <header class="chat-header">
            <a href="personalize.html" class="back-button" title="Change Mode">‚Ü©Ô∏è</a>
            
            <button id="tts-toggle-button" title="Turn on Text-to-Speech">üîá</button>
            <div class="lesson-selector">
                <select title="lesson-select" id="lesson-select"></select>
            </div>
        </header>

        <main class="message-list" id="message-list"></main>

        <footer class="chat-input-area">
            <input type="text" id="question-input" placeholder="Ask a question...">
            <button id="ask-button" title="Send">‚û§</button>
            <button id="record-button" title="Ask with voice">üéôÔ∏è</button>
        </footer>

    </div>

    <script>
        const messageList = document.getElementById('message-list');
        const lessonSelect = document.getElementById('lesson-select');
        const questionInput = document.getElementById('question-input');
        const askButton = document.getElementById('ask-button');
        const recordButton = document.getElementById('record-button');
        const ttsToggleButton = document.getElementById('tts-toggle-button');

        let currentMode = 'standard';
        const backendBaseUrl = 'http://127.0.0.1:5000';

        let isTtsEnabled = false; // Off by default
        let selectedVoice = null; 
        
        function createMessageBubble(sender, content) {
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble', `${sender}-message`);

            if (content.media && content.media.path) {
                const mediaPath = `${backendBaseUrl}/content/${content.lessonId}/${content.media.path}`;
                let mediaElement;

                if (content.media.type === 'image') {
                    mediaElement = document.createElement('img');
                } else if (content.media.type === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.controls = true; 
                }

                if (mediaElement) {
                    mediaElement.src = mediaPath;
                    bubble.appendChild(mediaElement);
                }
            }

            if (content.text) {
                const p = document.createElement('p');
                p.innerHTML = content.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                bubble.appendChild(p);
            }

            messageList.appendChild(bubble);
            messageList.scrollTop = messageList.scrollHeight;
            return bubble;
        }


        async function handleAskQuestion() {
            const question = questionInput.value.trim();
            const lessonId = lessonSelect.value;
            if (!question || !lessonId) return;
            createMessageBubble('user', { text: question });
            questionInput.value = '';

            const thinkingBubble = createMessageBubble('ai', { text: 'Thinking...' });
            askButton.disabled = true;
            recordButton.disabled = true;

            try {
                const response = await fetch(`${backendBaseUrl}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        lesson_id: lessonId,
                        mode: currentMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                messageList.removeChild(thinkingBubble);
                const aiContent = {
                    text: data.answer,
                    media: data.media,
                    lessonId: data.lesson_id
                };
                createMessageBubble('ai', aiContent);

                speakText(data.answer);

            } catch (error) {
                messageList.removeChild(thinkingBubble);
                createMessageBubble('ai', { text: `Sorry, I ran into an error: ${error.message}` });
                console.error("Error asking question:", error);
            } finally {
                askButton.disabled = false;
                recordButton.disabled = false;
            }
        }

        function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const modeFromURL = urlParams.get('mode');
            if (['standard', 'visual_assist', 'simplified'].includes(modeFromURL)) {
                currentMode = modeFromURL;
            }

            if (currentMode === 'visual_assist') {
                isTtsEnabled = true; 
            } else {
                isTtsEnabled = false; 
            }

            setupSpeechSynthesis(); 
            updateTtsButtonState(); 

            loadLessons();
            createMessageBubble('ai', { text: 'Hello! Please select a lesson to get started.' });
        }

        async function loadLessons() {
            try {
                const response = await fetch(`${backendBaseUrl}/lessons`);
                const lessons = await response.json();
                lessonSelect.innerHTML = '';
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.id;
                    option.textContent = lesson.title;
                    lessonSelect.appendChild(option);
                });
            } catch (error) { console.error("Error loading lessons:", error); }
        }

        function setupSpeechSynthesis() {
            function loadVoices() {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) return; 

                selectedVoice = voices.find(voice => voice.name === 'Google US English');
                
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Microsoft'));
                }
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => voice.lang === 'en-US' && voice.default);
                }
                console.log("Selected TTS Voice:", selectedVoice ? selectedVoice.name : "Browser Default");
            }
            
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function updateTtsButtonState() {
            if (isTtsEnabled) {
                ttsToggleButton.classList.add('tts-active');
                ttsToggleButton.textContent = 'üîä';
                ttsToggleButton.title = 'Turn off Text-to-Speech';
            } else {
                ttsToggleButton.classList.remove('tts-active');
                ttsToggleButton.textContent = 'üîá';
                ttsToggleButton.title = 'Turn on Text-to-Speech';
            }
        }

        function speakText(text) {
            if (!isTtsEnabled) return; 

            window.speechSynthesis.cancel(); 

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                window.speechSynthesis.speak(utterance);
            }
        }

        // --- Event Listeners ---
        askButton.addEventListener('click', handleAskQuestion);
        questionInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAskQuestion(); });

        ttsToggleButton.addEventListener('click', () => {
            isTtsEnabled = !isTtsEnabled; 
            updateTtsButtonState();       
            if (!isTtsEnabled) {
                window.speechSynthesis.cancel(); 
            }
        });

        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.onresult = (event) => {
                questionInput.value = event.results[0][0].transcript;
                handleAskQuestion();
            };
            recordButton.addEventListener('click', () => recognition.start());
        } else {
            recordButton.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>